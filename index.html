<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrow ğŸ¹ - Active alert system</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: #1a1a2e;
      color: white;
      padding: 0 20px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .brand { display: flex; align-items: center; gap: 10px; }

    .logo {
      width: 32px; height: 32px;
      background: #e53935; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px;
      animation: logoPulse 2.5s infinite;
    }
    @keyframes logoPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(229,57,53,0.5); }
      60%       { box-shadow: 0 0 0 10px rgba(229,57,53,0); }
    }

    .brand-text .t1 { font-size: 1.05em; font-weight: 700; }
    .brand-text .t2 { font-size: 0.7em;  color: rgba(255,255,255,0.5); }

    .header-right { display: flex; align-items: center; gap: 12px; }

    .status {
      display: flex; align-items: center; gap: 5px;
      font-size: 0.8em; color: rgba(255,255,255,0.7);
    }
    .sdot {
      width: 7px; height: 7px; border-radius: 50%;
      background: #4caf50;
    }
    .sdot.err  { background: #f44336; }
    .sdot.conn { background: #ff9800; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.2; } }

    .upd { font-size: 0.72em; color: rgba(255,255,255,0.35); }

    .btn {
      border: none; border-radius: 20px; padding: 5px 12px;
      cursor: pointer; font-size: 0.8em; transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.8; }
    .btn-sound { background: rgba(255,255,255,0.12); color: white; }
    .btn-demo  { background: rgba(255,193,7,0.18); color: #ffc107; border: 1px solid rgba(255,193,7,0.3); }

    /* â”€â”€ Layout â”€â”€ */
    .body {
      display: flex;
      flex: 1;
      overflow: hidden;
      direction: ltr;   /* keep map left, sidebar right */
    }

    #map { flex: 1; }

    /* â”€â”€ Sidebar â”€â”€ */
    aside {
      width: 340px;
      background: #fff;
      border-left: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: -2px 0 8px rgba(0,0,0,0.07);
      direction: rtl;
    }

    .sh {
      padding: 9px 14px;
      font-size: 0.82em; font-weight: 600; color: #555;
      background: #f9f9f9;
      border-bottom: 1px solid #ebebeb;
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }

    .badge {
      background: #e53935; color: white;
      border-radius: 12px; padding: 1px 8px;
      font-size: 0.8em; display: none;
    }

    /* Active section */
    #active-wrap { flex-shrink: 0; border-bottom: 1px solid #e0e0e0; }

    #active-body {
      padding: 8px;
      max-height: 290px;
      overflow-y: auto;
    }

    .ok {
      padding: 22px 16px;
      text-align: center; color: #43a047;
      font-size: 0.9em; font-weight: 500;
    }
    .ok .oi { font-size: 1.8em; margin-bottom: 5px; }

    .card {
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
      margin-bottom: 8px;
      animation: ci 0.28s ease;
    }
    @keyframes ci {
      from { opacity: 0; transform: translateX(12px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    .card-head {
      padding: 9px 12px;
      display: flex; align-items: center; gap: 8px;
      color: white;
    }
    .c1  .card-head { background: #e53935; }
    .c2  .card-head { background: #f57c00; }
    .c3  .card-head, .c101 .card-head { background: #546e7a; }
    .c4  .card-head { background: #7b1fa2; }
    .c5  .card-head { background: #f9a825; color: #333; }
    .c6  .card-head { background: #0277bd; }
    .c7  .card-head { background: #2e7d32; }
    .c8  .card-head { background: #00838f; }
    .c13 .card-head { background: #bf360c; }

    .ci { font-size: 1.1em; }
    .cn { font-weight: 700; font-size: 0.87em; }
    .cd { font-size: 0.73em; opacity: 0.85; }
    .cc {
      margin-right: auto; /* pushes to left in RTL */
      background: rgba(255,255,255,0.25);
      border-radius: 10px; padding: 2px 8px;
      font-size: 0.77em; font-weight: 600; white-space: nowrap;
    }

    .card-locs {
      padding: 7px 10px;
      display: flex; flex-wrap: wrap; gap: 4px;
      background: #fff;
    }

    .chip {
      border-radius: 4px; padding: 3px 8px;
      font-size: 0.75em; cursor: pointer;
      border: 1px solid; transition: all 0.15s;
    }
    .c1  .chip { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
    .c1  .chip:hover { background: #e53935; color: white; }
    .c2  .chip { background: #fff3e0; color: #e65100; border-color: #ffcc80; }
    .c2  .chip:hover { background: #f57c00; color: white; }
    .c3  .chip, .c101 .chip { background: #eceff1; color: #455a64; border-color: #b0bec5; }
    .c3  .chip:hover, .c101 .chip:hover { background: #546e7a; color: white; }
    .c13 .chip { background: #fbe9e7; color: #bf360c; border-color: #ffab91; }
    .c13 .chip:hover { background: #bf360c; color: white; }

    /* History section */
    #hist-wrap {
      flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;
    }
    #hist-body { flex: 1; overflow-y: auto; }

    .hi {
      display: flex; gap: 9px; align-items: flex-start;
      padding: 9px 14px; border-bottom: 1px solid #f0f0f0;
      font-size: 0.8em;
    }
    .hi:hover { background: #fafafa; }
    .hd {
      width: 9px; height: 9px; border-radius: 50%; margin-top: 4px; flex-shrink: 0;
    }
    .hd.d1  { background: #e53935; } .hd.d2  { background: #f57c00; }
    .hd.d3  { background: #546e7a; } .hd.d4  { background: #7b1fa2; }
    .hd.d13 { background: #bf360c; } .hd.dx  { background: #9e9e9e; }
    .hinfo { flex: 1; min-width: 0; }
    .ht    { font-weight: 600; color: #333; }
    .hl    { color: #888; margin-top: 2px; line-height: 1.4; }
    .htime { color: #bbb; font-size: 0.87em; white-space: nowrap; }

    /* Popup */
    .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.13); }
    .pop { text-align: right; direction: rtl; min-width: 120px; }
    .pop strong { display: block; font-size: 0.93em; }
    .pop .pc { color: #e53935; font-size: 0.8em; margin-top: 2px; }
    .pop .pd { color: #888;    font-size: 0.77em; margin-top: 1px; }

    .demo-tag {
      background: #ffc107; color: #333;
      font-size: 0.72em; font-weight: 700;
      padding: 2px 7px; border-radius: 4px;
      letter-spacing: 0.04em; vertical-align: middle;
    }
    .demo-banner {
      background: #fff8e1; border-bottom: 1px solid #ffc107;
      color: #795500; font-size: 0.8em;
      padding: 5px 14px; text-align: center;
      display: none;
    }
    .hdemo { /* history row demo marker */
      font-size: 0.7em; background: #fff8e1; color: #795500;
      border: 1px solid #ffc107; border-radius: 3px;
      padding: 1px 5px; vertical-align: middle; margin-right: 4px;
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ğŸš¨</div>
    <div class="brand-text">
      <div class="t1">××¤×ª ××–×¢×§×•×ª ×—×™×•×ª</div>
      <div class="t2">×¢×“×›×•×Ÿ ×‘×–××Ÿ ×××ª Â· ×¤×™×§×•×“ ×”×¢×•×¨×£</div>
    </div>
  </div>
  <div class="header-right">
    <span class="upd" id="upd"></span>
    <div class="status">
      <div class="sdot conn" id="sdot"></div>
      <span id="stxt">××ª×—×‘×¨...</span>
    </div>
    <button class="btn btn-sound" onclick="toggleSound()" id="bsound">ğŸ”Š ×§×•×œ</button>
    <button class="btn btn-demo"  onclick="loadDemo()">×˜×¢×Ÿ ×“××•</button>
  </div>
</header>

<div class="demo-banner" id="demo-banner">âš ï¸ ××¦×‘ ×“××• â€” ×”× ×ª×•× ×™× ××™× × ×××™×ª×™×™×</div>
<div class="body">
  <div id="map"></div>

  <aside>
    <div id="active-wrap">
      <div class="sh">
        <span>××–×¢×§×•×ª ×¤×¢×™×œ×•×ª</span>
        <span class="badge" id="badge">0</span>
      </div>
      <div id="active-body">
        <div class="ok"><div class="oi">âœ“</div>××™×Ÿ ××–×¢×§×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</div>
      </div>
    </div>

    <div id="hist-wrap">
      <div class="sh">
        <span>×”×™×¡×˜×•×¨×™×”</span>
        <span id="hcount" style="color:#bbb;font-size:0.85em"></span>
      </div>
      <div id="hist-body">
        <div style="padding:16px;text-align:center;color:#ccc;font-size:0.8em">×××ª×™×Ÿ ×œ××–×¢×§×•×ª...</div>
      </div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const ALERTS_URL  = '/api/alerts';
const HISTORY_URL = '/api/history';
const POLL_MS     = 1000;
let isDemo = false;

const CATS = {
  1:   { icon:'ğŸš€', label:'×™×¨×™ ×¨×§×˜×•×ª ×•×˜×™×œ×™×',    color:'#e53935', cls:'c1',   dot:'d1'  },
  2:   { icon:'âš ï¸', label:'×¢×™××•×ª ××–×¨×—×™',          color:'#f57c00', cls:'c2',   dot:'d2'  },
  3:   { icon:'ğŸ”µ', label:'×ª×¨×’×™×œ',                color:'#546e7a', cls:'c3',   dot:'d3'  },
  4:   { icon:'ğŸŒ', label:'×¨×¢×™×“×ª ××“××”',           color:'#7b1fa2', cls:'c4',   dot:'d4'  },
  5:   { icon:'â˜£ï¸', label:'×—×•××¨×™× ××¡×•×›× ×™×',       color:'#f9a825', cls:'c5',   dot:'dx'  },
  6:   { icon:'ğŸŒŠ', label:'×’×œ ×¦×•× ×××™',            color:'#0277bd', cls:'c6',   dot:'dx'  },
  7:   { icon:'â˜¢ï¸', label:'×—×•××¨×™× ×¨×“×™×•××§×˜×™×‘×™×™×',  color:'#2e7d32', cls:'c7',   dot:'dx'  },
  8:   { icon:'ğŸŒªï¸', label:'××–×’ ××•×™×¨ ×§×™×¦×•× ×™',      color:'#00838f', cls:'c8',   dot:'dx'  },
  13:  { icon:'ğŸ”¥', label:'×©×¨×™×¤×•×ª',               color:'#bf360c', cls:'c13',  dot:'d13' },
  101: { icon:'ğŸ”µ', label:'×ª×¨×’×™×œ - ×¨×§×˜×•×ª',        color:'#546e7a', cls:'c101', dot:'d3'  },
};
const cat = n => CATS[+n] || { icon:'â—', label:'×”×ª×¨×¢×”', color:'#e53935', cls:'c1', dot:'d1' };

const LOCS = {
  '×ª×œ ××‘×™×‘':[32.0853,34.7818],'×ª×œ ××‘×™×‘-×™×¤×•':[32.0853,34.7818],'×™×¤×•':[32.0478,34.7503],
  '×™×¨×•×©×œ×™×':[31.7683,35.2137],'×—×™×¤×”':[32.7940,34.9896],'×‘××¨ ×©×‘×¢':[31.2530,34.7915],
  '××™×œ×ª':[29.5577,34.9519],'× ×ª× ×™×”':[32.3215,34.8532],'××©×“×•×“':[31.8044,34.6553],
  '××©×§×œ×•×Ÿ':[31.6688,34.5743],'×¤×ª×— ×ª×§×•×•×”':[32.0870,34.8872],'×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ':[31.9730,34.7925],
  '×—×•×œ×•×Ÿ':[32.0100,34.7731],'×‘× ×™ ×‘×¨×§':[32.0833,34.8333],'×‘×ª ×™×':[32.0204,34.7508],
  '×¨××ª ×’×Ÿ':[32.0678,34.8228],'×’×‘×¢×ª×™×™×':[32.0694,34.8100],'××•×¨ ×™×”×•×“×”':[32.0297,34.8533],
  '×§×¨×™×™×ª ××•× ×•':[32.0625,34.8608],'×¨××ª ×”×©×¨×•×Ÿ':[32.1461,34.8383],'×”×¨×¦×œ×™×”':[32.1625,34.8436],
  '×›×¤×¨ ×¡×‘×':[32.1783,34.9064],'×¨×¢× × ×”':[32.1839,34.8706],'×”×•×“ ×”×©×¨×•×Ÿ':[32.1503,34.8919],
  '×›×•×›×‘ ×™××™×¨':[32.2072,34.9753],'×¨××© ×”×¢×™×Ÿ':[32.0956,34.9570],'××‘×Ÿ ×™×”×•×“×”':[32.2653,34.8908],
  '× ×¡ ×¦×™×•× ×”':[31.9289,34.7981],'×¨×—×•×‘×•×ª':[31.8947,34.8147],'××•×“×™×¢×™×Ÿ':[31.8980,35.0100],
  '××•×“×™×¢×™×Ÿ-××›×‘×™×-×¨×¢×•×ª':[31.8980,35.0100],'×œ×•×“':[31.9517,34.9019],'×¨××œ×”':[31.9303,34.8728],
  '×’×“×¨×”':[31.8131,34.7783],'×™×‘× ×”':[31.8764,34.7394],'×—×“×¨×”':[32.4350,34.9194],
  '×¢×›×•':[32.9178,35.0719],'× ×”×¨×™×”':[33.0072,35.0975],'×›×¨××™××œ':[32.9125,35.2978],
  '××¢×œ×•×ª-×ª×¨×©×™×—×':[33.0167,35.2833],'××¢×œ×•×ª':[33.0167,35.2833],
  '×§×¨×™×™×ª ×©××•× ×”':[33.2072,35.5696],'×§×¨×™×ª ×©××•× ×”':[33.2072,35.5696],
  '×¦×¤×ª':[32.9646,35.4960],'×˜×‘×¨×™×”':[32.7921,35.5312],'× ×¦×¨×ª':[32.7001,35.2981],
  '×¢×¤×•×œ×”':[32.6073,35.2894],'×™×§× ×¢× ×¢×™×œ×™×ª':[32.6567,35.1067],
  '×™×§× ×¢× ×”××•×©×‘×” ×•×”×–×•×¨×¢':[32.6567,35.1067],
  '×§×¨×™×™×ª ×˜×‘×¢×•×Ÿ':[32.7011,35.1217],'×§×¨×™×ª ×˜×‘×¢×•×Ÿ - ×‘×™×ª ×–×™×™×“':[32.7011,35.1217],
  '×–×›×¨×•×Ÿ ×™×¢×§×‘':[32.5731,34.9571],'×‘× ×™××™× ×”':[32.5256,34.9456],
  '×§×¨×™×™×ª ×’×ª':[31.6100,34.7639],'×§×¨×™×ª ×’×ª':[31.6100,34.7639],
  '×™×¨×•×—×':[30.9883,34.9317],'××¦×¤×” ×¨××•×Ÿ':[30.6100,34.8019],
  '×“×™××•× ×”':[31.0670,35.0320],'×¢×¨×“':[31.2586,35.2128],'×¨×”×˜':[31.3940,34.7558],
  '×©×“×¨×•×ª':[31.5253,34.5969],'× ×ª×™×‘×•×ª':[31.4228,34.5942],'××•×¤×§×™×':[31.3111,34.6214],
  '×§×¨×™×™×ª ×™×':[32.8453,35.0686],'×§×¨×™×ª ×™×':[32.8453,35.0686],
  '×§×¨×™×™×ª ××•×¦×§×™×Ÿ':[32.8361,35.0756],'×§×¨×™×ª ××•×¦×§×™×Ÿ':[32.8361,35.0756],
  '×§×¨×™×™×ª ×‘×™××œ×™×§':[32.8239,35.0808],'×§×¨×™×ª ×‘×™××œ×™×§':[32.8239,35.0808],
  '×§×¨×™×™×ª ××ª×':[32.8100,35.1047],'×§×¨×™×ª ××ª×':[32.8100,35.1047],
  '×˜×™×¨×ª ×›×¨××œ':[32.7567,34.9694],'×˜×™×¨×ª ×”×›×¨××œ':[32.7567,34.9694],
  '× ×©×¨':[32.7686,35.0436],'×§×¦×¨×™×Ÿ':[32.9989,35.6892],
  '× ×•×£ ×”×’×œ×™×œ':[32.6869,35.3117],'××’×“×œ ×”×¢××§':[32.6733,35.2408],
  // Haifa / Carmel
  '×›×¤×¨ ×”××›×‘×™':[32.7239,35.0772],'××¢×’×Ÿ ××™×›××œ':[32.5478,34.9172],
  '××‘×™××œ':[32.5050,34.9728],'××¢×œ×” ×¢×™×¨×•×Ÿ':[32.5339,35.0489],
  '×¢×ª×œ×™×ª':[32.6942,34.9428],'××•×¢××•×•×™×”':[32.5572,35.0756],
  '×”×¨×¨×™×ª ×™×—×“':[32.8611,35.2011],'××•×¨× ×™×':[32.7133,35.1178],
  '××™×‘×˜×™×Ÿ':[32.7311,35.0742],'××œ×•× ×™×':[32.7253,35.0881],
  '×‘×™×¨ ××œ××›×¡×•×¨':[32.7661,35.1528],'×‘×™×ª ××•×¨×Ÿ':[32.7394,35.0119],
  '×‘×¡××ª ×˜×‘×¢×•×Ÿ':[32.7461,35.1208],'×’×‘×¢×ª ×•×•×œ×¤×¡×•×Ÿ':[32.5597,35.0431],
  '×“×œ×™×ª ××œ ×›×¨××œ':[32.6975,35.0611],'×“××™×™×“×”':[32.5903,35.1392],
  '×”×¨×“×•×£':[32.7533,35.1203],'×™×’×•×¨':[32.7400,35.0569],
  '×›×¢×‘×™×” ×˜×‘××©':[32.6717,35.1222],'×›×¤×¨ ×—×¡×™×“×™×':[32.7517,35.0819],
  '×›×¤×¨ ×™×”×•×©×¢':[32.6572,35.1078],'×›×¤×¨ ×× ×“×':[32.8136,35.2517],
  '×›×¤×¨ ×ª×§×•×•×”':[32.6317,35.0878],'××¨×—×‘×™×” ××•×©×‘':[32.6069,35.2011],
  '××¨×—×‘×™×” ×§×™×‘×•×¥':[32.6019,35.2078],'× ××¢×•×¨×”':[32.5989,35.1522],
  '× ×•×¤×™×ª':[32.7286,35.1225],'×¡×•×œ×':[32.5919,35.2022],
  '×¢×“×™':[32.7133,35.1028],'×¢×¡×¤×™×':[32.7267,35.0589],
  '×¨××¡ ×¢×œ×™':[32.7533,35.1394],'×¨×›×¡×™×':[32.7694,35.0994],
  '×¨××ª ×™×©×™':[32.7264,35.1694],'×©×“×” ×™×¢×§×‘':[32.6672,35.1219],
  '×©×¢×¨ ×”×¢××§×™×':[32.7181,35.0847],'×©×¤×¨×¢×':[32.8028,35.1722],
  '××œ×™×§×™×':[32.6600,35.0581],"×’×‘×¢×ª × ×™×œ''×™":[32.5236,34.9917],
  '×’×œ×¢×“':[32.4808,35.0083],'×“×œ×™×”':[32.6108,35.0761],
  '××“×¨×š ×¢×•×–':[32.5992,35.1731],'××¢×™×™×Ÿ ×¦×‘×™':[32.5817,34.9425],
  '××©××¨ ×”×¢××§':[32.6178,35.1339],'×¢×™×Ÿ ×”×¢××§':[32.5956,35.0742],
  '×¢×™×Ÿ ×”×©×•×¤×˜':[32.6547,35.0711],'×¢××™×§×':[32.5122,35.0264],
  '×§×™×‘×•×¥ ××’×™×“×•':[32.5852,35.1817],'×¨××•×ª ×× ×©×”':[32.6233,35.0822],
  '×¨××ª ×”×©×•×¤×˜':[32.6583,35.0597],
  '××–×•×¨ ×ª×¢×©×™×™×” ×™×§× ×¢× ×¢×™×œ×™×ª':[32.6567,35.1067],
  '××–×•×¨ ×ª×¢×©×™×™×” ××‘×•× ×›×¨××œ':[32.7133,34.9742],
  '××–×•×¨ ×ª×¢×©×™×™×” × ×™×¨ ×¢×¦×™×•×Ÿ':[32.6878,35.0117],
  '××–×•×¨ ×ª×¢×©×™×™×” ××‘×•××•×ª ×”×’×œ×‘×•×¢':[32.5742,35.2058],
  '××–×•×¨ ×ª×¢×©×™×™×” ××œ×•×Ÿ ×”×ª×‘×•×¨':[32.6883,35.4244],
  '××–×•×¨ ×ª×¢×©×™×™×” ×§×“××ª ×’×œ×™×œ':[32.9125,35.2978],
  '××–×•×¨ ×ª×¢×©×™×™×” ×¦×™×¤×•×¨×™×ª':[32.7528,35.2803],
  '××–×•×¨ ×ª×¢×©×™×™×” ×‘× ×™ ×™×”×•×“×”':[32.8778,35.7247],
  '×‘×™×ª ×¡×•×”×¨ ×§×™×©×•×Ÿ':[32.7978,35.0778],'×‘×™×ª ×¦×‘×™':[32.6578,35.0236],
  '×‘×ª ×©×œ××”':[32.5831,34.9856],'×’×‘×¢ ×›×¨××œ':[32.6658,35.0044],
  '×“×•×¨, × ×—×©×•×œ×™×':[32.6136,34.9108],'×”×‘×•× ×™×':[32.6394,34.9275],
  '×”×™×•×’×‘':[32.6417,35.1958],'×›×¤×¨ ×‘×¨×•×š':[32.6283,35.2008],
  "×›×¨× ××”×¨''×œ":[32.6736,34.9869],'×××™×¨ ×©×¤×™×”':[32.6322,34.9519],
  "××¨×›×– ××™×¨''×‘":[32.5831,35.0544],'× ×•×•×” ×™×':[32.6006,34.9217],
  '× ×™×¨ ×¢×¦×™×•×Ÿ, ×™××™×Ÿ ××•×¨×“':[32.6878,35.0117],'×¢×•×¤×¨':[32.6644,35.0211],
  '×¢×™×Ÿ ××™×™×œ×”':[32.5769,34.9739],'×¢×™×Ÿ ×”×•×“':[32.6878,35.0164],
  '×¢×™×Ÿ ×—×•×“':[32.6956,35.0267],'×¢×™×Ÿ ×›×¨××œ':[32.6622,35.0344],
  '×¤×•×¨×™×™×“×™×¡':[32.6092,34.9683],'×¦×¨×•×¤×”':[32.6267,34.9903],
  '×’×‘×¢×ª ×¢×•×–':[32.6039,35.1625],'×¡×•××¢×“ ×—××™×¨×”':[32.6239,35.1283],
  '×ª×—× ×ª ×¨×›×‘×ª ×›×¤×¨ ×™×”×•×©×•×¢':[32.6572,35.1078],
  '×ª×—× ×ª ×¨×›×‘×ª ×›×¤×¨ ×‘×¨×•×š':[32.6283,35.2008],
  '×‘×™×ª ×¢×œ××™×Ÿ ×ª×œ ×¨×’×‘':[32.7197,35.1228],
  "×›×¤×¨ ×—'×•×•××œ×“":[32.6614,35.1444],
  "×‘×™\"×¡ ×›×¨××™× ×‘× ×™××™× ×”":[32.5256,34.9456],
  // Jezreel Valley
  '××—×•×–×ª ×‘×¨×§':[32.6133,35.2356],'××›×¡××œ':[32.6958,35.3011],
  '××œ×•×Ÿ ×”×’×œ×™×œ':[32.7547,35.4025],'××œ×•× ×™ ××‘×':[32.7417,35.1544],
  '×‘×™×ª ×œ×—× ×”×’×œ×™×œ×™×ª':[32.7053,35.2006],'×‘×™×ª ×©×¢×¨×™×':[32.7044,35.1031],
  '×‘×œ×¤×•×¨×™×”':[32.6406,35.2525],'×’×‘×¢×ª ××œ×”':[32.7261,35.1794],
  '×’×‘×ª':[32.6775,35.2053],'×’× ×™×’×¨':[32.6564,35.1853],
  '×’×©×¨':[32.5500,35.5308],'×“×‘×¨×ª':[32.6808,35.3397],
  '×“×—×™':[32.5883,35.1194],'×”×•×©×¢×™×”':[32.7572,35.2922],
  '×”×¡×•×œ×œ×™×':[32.7086,35.2461],'×–×¨×–×™×¨':[32.7131,35.2050],
  "×—×’'××’'×¨×”":[32.6594,35.2736],'×—× ×ª×•×Ÿ':[32.7978,35.2678],
  '×˜××¨×” ×‘×’×œ×‘×•×¢':[32.5658,35.2617],'×™×¤×™×¢':[32.6917,35.3000],
  '×™×¤×¢×ª':[32.6817,35.2233],'×›×¤×¨ ×’×“×¢×•×Ÿ':[32.5889,35.2736],
  '×›×¤×¨ ×”×—×•×¨×©':[32.7294,35.2656],'×›×¤×¨ ×›× ×':[32.7472,35.3481],
  '×›×¤×¨ × ×”×¨ ×”×™×¨×“×Ÿ':[32.5667,35.5156],'××–×¨×¢':[32.7253,35.1208],
  '×× ×©×™×ª ×–×‘×“×”':[32.5906,35.1472],'××¦×¤×”':[32.7450,35.2847],
  '××©×”×“':[32.7478,35.3406],'× ×”×œ×œ':[32.6661,35.1836],
  '× ×™×Ÿ':[32.5717,35.2319],'×¢×™×œ×•×˜':[32.7256,35.2508],
  '×¢×™×Ÿ ×××”×œ':[32.7453,35.3269],'×¦×™×¤×•×¨×™':[32.7528,35.2803],
  '×¨×™×™× ×”':[32.7392,35.3050],'×¨××ª ×“×•×“':[32.6644,35.1675],
  '×©××©×™×ª':[32.6814,35.1417],'×©×¨×™×“':[32.6531,35.1706],
  '×ª×œ ×¢×“×©×™×':[32.6431,35.2019],'×ª××¨×ª':[32.6914,35.1858],
  // Lower Galilee / Sea of Galilee
  '××‘×˜×œ×™×•×Ÿ':[32.8628,35.3206],'××™×œ× ×™×”':[32.7706,35.4183],
  '××œ×•××•×ª':[32.6567,35.5558],'××¨×‘×œ':[32.8333,35.4819],
  '××©×“×•×ª ×™×¢×§×‘':[32.6478,35.5667],
  "×‘×•×¢×™×™× ×”-× ×•×’'×™×“××ª":[32.8164,35.3850],
  '×‘×™×ª ×–×¨×¢':[32.6956,35.5683],'×‘×™×ª ×™×¨×—':[32.7178,35.5508],
  '×‘×™×ª ×§×©×ª':[32.7244,35.3717],'×‘×™×ª ×¨×™××•×Ÿ':[32.7897,35.3108],
  '×’×™× ×•×¡×¨':[32.8467,35.5222],'×’×–×™×ª':[32.6733,35.3767],
  '×“×’× ×™×” ×':[32.7103,35.5633],'×“×’× ×™×” ×‘':[32.7047,35.5689],
  '×“×‘×•×¨×™×”':[32.6808,35.3397],'×”××•×Ÿ':[32.7631,35.6169],
  '×”×•×“×™×•×ª':[32.8869,35.3108],'×”×–×•×¨×¢×™×':[32.6972,35.5500],
  '×•××“×™ ××œ ×—×××':[32.8286,35.5228],'×—××ª ×’×“×¨':[32.6864,35.6594],
  '×˜×•×¨×¢××Ÿ':[32.7800,35.3422],'×™×‘× ××œ':[32.7253,35.4994],
  '×›×“×•×¨×™':[32.7089,35.3297],'×›×™× ×¨×ª ××•×©×‘×”':[32.7072,35.5594],
  '×›×™× ×¨×ª ×§×‘×•×¦×”':[32.7028,35.5633],'×›× ×£':[32.7894,35.6683],
  '×›×¤×¨ ×–×™×ª×™×':[32.8400,35.5225],'×›×¤×¨ ×—×™×˜×™×':[32.8347,35.5022],
  '×›×¤×¨ ×—×¨×•×‘':[32.8008,35.6681],'×›×¤×¨ ×›××':[32.7242,35.4394],
  '×›×¤×¨ ××¦×¨':[32.6967,35.5167],'×›×¤×¨ ×§×™×©':[32.7378,35.4239],
  '×›×¤×¨ ×ª×‘×•×¨':[32.6883,35.4244],'×œ×‘×™×':[32.8456,35.4572],
  '×œ×‘× ×™×':[32.8636,35.5181],'××‘×•× ×—××”':[32.8283,35.6822],
  '××’×“×œ':[32.8422,35.5022],'××™×¦×¨':[32.6431,35.5200],
  '×× ×—××™×”':[32.6500,35.5283],'××¡×“':[32.9269,35.3961],
  '××¡×“×”':[32.6714,35.5994],'××¢×’×Ÿ':[32.6850,35.5844],
  '××¦×¤×” × ×˜×•×¤×”':[32.8547,35.3436],'× ×‘×™ ×©×•×¢×™×™×‘':[32.8167,35.4181],
  '× ×•×‘':[32.8717,35.6908],'× ×˜×•×¨':[32.8503,35.6656],
  '×¢×•×–×™×™×¨, ×¨×•××× ×”':[32.7008,35.3217],'×¢×™×œ×‘×•×Ÿ':[32.8414,35.3758],
  '×¢×™×Ÿ ×’×‘':[32.8006,35.6631],'×¢×™×Ÿ ×“×•×¨':[32.6139,35.3925],
  '×¤×•×¨×™×” ×›×¤×¨ ×¢×‘×•×“×”':[32.7481,35.5164],'×¤×•×¨×™×” × ×•×•×” ×¢×•×‘×“':[32.7561,35.5250],
  '×¤×•×¨×™×” ×¢×™×œ×™×ª':[32.7633,35.5278],'×¦××—':[32.7239,35.5786],
  '×¨×‘×™×“':[32.8733,35.4633],'×¨×•××ª ××œ ×”×™×™×‘':[32.9225,35.3294],
  '×©×“×” ××™×œ×Ÿ':[32.7053,35.4494],'×©×“××•×ª ×“×‘×•×¨×”':[32.6703,35.3397],
  "×©×™×‘×œ×™ ××•× ××œ×’'× ×":[32.5889,35.3022],
  '×©×¢×¨ ×”×’×•×œ×Ÿ':[32.6939,35.5833],'×©×¨×•× ×”':[32.6983,35.5294],
  '×ª×œ ×§×¦×™×¨':[32.6992,35.5956],
  // Golan Heights
  '××‘× ×™ ××™×ª×Ÿ':[32.9225,35.6408],'××œ×™ ×¢×“':[33.0017,35.6658],
  '××¤×™×§':[32.7814,35.6631],'××¤×™×§×™×':[32.6761,35.5936],
  '×‘× ×™ ×™×”×•×“×” ×•×’×‘×¢×ª ×™×•××‘':[32.8778,35.7247],
  '×’×‘×¢×ª ××‘× ×™':[32.8594,35.6458],'×’×©×•×¨':[32.8583,35.7133],
  '×—×¡×¤×™×Ÿ':[32.9189,35.7278],'× ××•×ª ×’×•×œ×Ÿ':[32.9169,35.7325],
  '×¨××•×ª':[32.8972,35.7200],'×¨××ª ××’×©×™××™×':[32.9017,35.6956],
  "××’'×“ ××œ ×©××¡":[33.2750,35.7700],'×¢×™×Ÿ ×§× ×™×™×”':[33.2561,35.7372],
  '××¡×¢×“×”':[33.2378,35.7622],'×‘×•×§×¢×ª×':[33.2050,35.7689],
  '×¢×™×Ÿ ×–×™×•×•×Ÿ':[32.9853,35.7381],'××œ ×¨×•×':[33.1253,35.7608],
  '× ××¨×•×“':[33.2533,35.7178],
  // Upper Galilee / Lebanon border
  '××˜×•×œ×”':[33.2750,35.5728],'×©×œ×•××™':[33.0747,35.1422],
  '×¨××© ×”× ×§×¨×”':[33.0881,35.1006],'×›×™×¡×¨× ×¡××™×¢':[33.0197,35.3358],
  '×™×¢×¨×”':[33.0592,35.2256],'×¤×¡×•×˜×”':[33.0461,35.2806],
  '×’×©×¨ ×”×–×™×•':[33.0294,35.1211],'×‘×Ÿ ×¢××™':[32.9942,35.1333],
  '×œ×•×—××™ ×”×’×™×˜××•×ª':[32.9714,35.1108],'×™×—×™×¢×':[32.9908,35.2411],
  '××‘×™×¨×™×':[33.0208,35.2356],'×©××¨ ×™×©×•×‘':[33.2456,35.5483],
  '×“×¤× ×”':[33.2406,35.6222],'×“×Ÿ':[33.2578,35.6525],
  '×›×¤×¨ ×’×œ×¢×“×™':[33.2450,35.5650],'××—× ×™×™×':[33.0989,35.5972],
  '×¨×××”':[32.9353,35.3625],'×× ×•×ª':[33.0236,35.2839],
  '×©× ×™×¨':[33.2336,35.6419],
  // Gaza border / South
  '× ×—×œ ×¢×•×–':[31.4817,34.5342],'×–×™×§×™×':[31.6378,34.5131],
  '× ×™×¨ ×¢×•×–':[31.4003,34.5167],'×‘××¨×™':[31.4375,34.5358],
  '×¨×¢×™×':[31.3844,34.5197],'×›×¤×¨ ×¢×–×”':[31.4617,34.5378],
  '× ×¦×¨ ×—×–× ×™':[31.5700,34.5989],'×’×Ÿ ×™×‘× ×”':[31.7878,34.7083],
  '×›×™×¡×•×¤×™×':[31.4183,34.4783],'×¢×™×Ÿ ×”×©×œ×•×©×”':[31.2531,34.4839],
  '× ×™×¨×™×':[31.4036,34.5400],'××•×¨×™×':[31.3808,34.5842],
  '×™×©×¢':[31.3342,34.5814],'××’×Ÿ':[31.3561,34.5208],
  '×ª×§×•××”':[31.4086,34.6028],'×§×™×‘×•×¥ × ×™×¨ ××':[31.4483,34.6100],
  '×’×‘×•×œ×•×ª':[31.2564,34.5050],'×™×“ ××¨×“×›×™':[31.5697,34.5689],
  '× ×™×¦×Ÿ':[31.7258,34.6228],'× ×™×¦× ×™×':[31.7425,34.6089],
  '× ×’×‘×”':[31.6742,34.6942],'×ª×œ ×©×‘×¢':[31.2628,34.8344],
  '×›×¡×™×™×¤×”':[31.3381,34.8619],'×¢×¨×¢×¨×” ×‘× ×’×‘':[31.3233,34.8636],
  '×œ×§×™×”':[31.3914,34.8236],'×©×’×‘ ×©×œ×•×':[31.3022,34.8844],
  '×—×•×¨×”':[31.2894,34.9333],'×œ×”×‘×™×':[31.3683,34.8172],
  '××™×ª×¨':[31.3681,34.9092],'×’×™×œ×ª':[31.3333,34.6689],
  '×‘×¨×•×©':[31.4536,34.7019],'××©××¨ ×”× ×’×‘':[31.3672,34.7567],
  '×¡×¤×™×¨':[30.9983,34.9167],
  // Jerusalem area
  '×‘×™×ª ×©××©':[31.7469,34.9889],'××‘×©×¨×ª ×¦×™×•×Ÿ':[31.8031,35.1281],
  '×’×‘×¢×ª ×–××‘':[31.8806,35.1703],'××¢×œ×” ××“×•××™×':[31.7778,35.3011],
  '×‘×™×ª×¨ ×¢×™×œ×™×ª':[31.6953,35.1192],
  // Sharon / Central
  '×’× ×™ ×ª×§×•×•×”':[32.0608,34.8783],'×§×œ× ×¡×•×•×”':[32.2842,34.9950],
  '×˜×™×™×‘×”':[32.2664,35.0036],'×˜×™×¨×”':[32.2286,34.9536],
  '×›×¤×¨ ×§××¡×':[32.1133,34.9736],"×’'×œ×’'×•×œ×™×”":[32.1575,34.9569],
  '××©××¨×ª':[32.2836,34.9311],'××œ×§× ×”':[32.1181,35.0236],
  '××¨×™××œ':[32.1061,35.1722],'×›×¨× ×™ ×©×•××¨×•×Ÿ':[32.1747,35.0364],
  // Missing from alerts.json
  '××ª×¨ ×”×”× ×¦×—×” ×’×•×œ× ×™':[32.6897,35.2969],
  "×‘×•×¢×™×™× ×”-× ×•×’'×™×“××ª":[32.8164,35.3850],
  '×‘×™×ª ×¡×•×”×¨ ×›×¨××™× ×‘× ×™××™× ×”':[32.5256,34.9456],
  "×’×‘×¢×ª × ×™×œ''×™":[32.5236,34.9917],
  "×—×’'××’'×¨×”":[32.6594,35.2736],
  '×™×©×•×‘×™ ××•××Ÿ':[32.6108,35.0761],
  "×›×¤×¨ ×—'×•×•××œ×“":[32.6614,35.1444],
  "×›×¨× ××”×¨''×œ":[32.6736,34.9869],
  "××¨×›×– ××™×¨''×‘":[32.5831,35.0544],
};

const map = L.map('map').setView([31.5, 34.9], 8);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

const mkIcon = color => L.divIcon({
  className: '',
  html: `<div style="width:18px;height:18px;border-radius:50%;background:${color};border:3px solid #fff;animation:ap 1.5s infinite"></div>
         <style>@keyframes ap{0%{box-shadow:0 0 0 2px ${color}88}60%{box-shadow:0 0 0 14px ${color}11}100%{box-shadow:0 0 0 2px ${color}88}}</style>`,
  iconSize:[18,18], iconAnchor:[9,9], popupAnchor:[0,-12]
});

let markers = [];
function clearMarkers() { markers.forEach(m => map.removeLayer(m)); markers = []; }

function addMarker(name, ll, c, alertData) {
  const m = L.marker(ll, { icon: mkIcon(c.color) }).addTo(map);
  m.bindPopup(`<div class="pop"><strong>${name}</strong><div class="pc">${c.icon} ${alertData.title}</div><div class="pd">${alertData.desc||''}</div></div>`);
  markers.push(m);
}

// Place markers for all locations found in the static table.
// Locations not in the table are shown in the sidebar chips only.
function placeMarkers(alertData) {
  const c = cat(alertData.cat);
  for (const name of (alertData.data || [])) {
    const ll = LOCS[name];
    if (ll) addMarker(name, ll, c, alertData);
  }
  // Zoom to fit all markers once â€” never again until the next new alert
  if (markers.length > 0) {
    try { map.fitBounds(L.featureGroup(markers).getBounds().pad(0.35), { maxZoom: 12, animate: false }); } catch(e) {}
  }
}

let ctx = null, soundOn = true;

function toggleSound() {
  soundOn = !soundOn;
  document.getElementById('bsound').textContent = soundOn ? 'ğŸ”Š ×§×•×œ' : 'ğŸ”‡ ×§×•×œ';
}

function playAlert() {
  if (!soundOn) return;
  try {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    [880,660,880,660].forEach((hz, i) => {
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = hz; o.type = 'sine';
      const t = ctx.currentTime + i * 0.26;
      g.gain.setValueAtTime(0.28, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.22);
      o.start(t); o.stop(t + 0.26);
    });
  } catch(e) {}
}

async function loadHistory() {
  try {
    const res  = await fetch(HISTORY_URL, { cache: 'no-store' });
    const data = await res.json();
    renderHistory(Array.isArray(data) ? data : []);
  } catch(e) {
    renderHistory([]);
  }
}

function renderActive(alert) {
  const body = document.getElementById('active-body');
  const badge = document.getElementById('badge');
  if (!alert) {
    body.innerHTML = `<div class="ok"><div class="oi">âœ“</div>××™×Ÿ ××–×¢×§×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</div>`;
    badge.style.display = 'none';
    return;
  }
  const c = cat(alert.cat);
  const locs = alert.data || [];
  badge.textContent = locs.length;
  badge.style.display = 'inline';
  const chips = locs.map(l =>
    `<span class="chip" onclick="focusLoc(${JSON.stringify(l)})">${l}</span>`
  ).join('');
  const demoTag = isDemo ? `<span class="demo-tag">×“××•</span> ` : '';
  body.innerHTML = `<div class="card ${c.cls}">
    <div class="card-head">
      <span class="ci">${c.icon}</span>
      <div><div class="cn">${demoTag}${alert.title}</div><div class="cd">${alert.desc||''}</div></div>
      <span class="cc">${locs.length} ×™×™×©×•×‘×™×</span>
    </div>
    <div class="card-locs">${chips}</div>
  </div>`;
}

function renderHistory(items) {
  const body  = document.getElementById('hist-body');
  const count = document.getElementById('hcount');
  if (!items || !items.length) {
    body.innerHTML = `<div style="padding:16px;text-align:center;color:#ccc;font-size:0.8em">××™×Ÿ ××–×¢×§×•×ª ×©××•×¨×•×ª</div>`;
    count.textContent = '';
    return;
  }
  count.textContent = items.length;
  body.innerHTML = items.map(h => {
    const c     = cat(h.cat);
    const shown = (h.data||[]).slice(0, 4).join('ØŒ ');
    const more  = (h.data||[]).length > 4 ? ` ×•×¢×•×“ ${h.data.length - 4}` : '';
    const demo  = h.demo ? `<span class="hdemo">×“××•</span>` : '';
    return `<div class="hi">
      <div class="hd ${c.dot}"></div>
      <div class="hinfo">
        <div class="ht">${demo}${c.icon} ${h.title}</div>
        <div class="hl">${shown}${more}</div>
      </div>
      <div class="htime">${relTime(h.alertDate || h.savedAt)}</div>
    </div>`;
  }).join('');
}

function relTime(iso) {
  if (!iso) return '';
  try {
    const d = Date.now() - new Date(iso);
    const m = Math.floor(d / 60000);
    if (m < 1)    return '×¢×›×©×™×•';
    if (m < 60)   return `×œ×¤× ×™ ${m} ×“×§'`;
    if (m < 1440) return `×œ×¤× ×™ ${Math.floor(m/60)} ×©'`;
    return new Date(iso).toLocaleDateString('he-IL', { day:'numeric', month:'short' });
  } catch(e) { return ''; }
}

function setStatus(cls, txt) {
  document.getElementById('sdot').className = 'sdot ' + cls;
  document.getElementById('stxt').textContent = txt;
}

function focusLoc(name) {
  const ll = LOCS[name];
  if (!ll) return;
  map.setView(ll, 14, { animate: true });
  for (const m of markers) {
    const p = m.getLatLng();
    if (Math.abs(p.lat - ll[0]) < 0.002 && Math.abs(p.lng - ll[1]) < 0.002) {
      m.openPopup(); break;
    }
  }
}

const DEMO_ALERTS = [
  {
    id: "demo1",
    cat: "1",
    title: "×™×¨×™ ×¨×§×˜×•×ª ×•×˜×™×œ×™×",
    data: ["×ª×œ ××‘×™×‘", "×™×¤×•", "×¨××ª ×’×Ÿ", "×’×‘×¢×ª×™×™×", "×‘× ×™ ×‘×¨×§"],
    desc: "×”×™×›× ×¡×• ×œ××¨×—×‘ ×”××•×’×Ÿ"
  },
  {
    id: "demo2", 
    cat: "2",
    title: "×¢×™××•×ª ××–×¨×—×™",
    data: ["×™×¨×•×©×œ×™×", "×‘×™×ª ×©××©", "××‘×©×¨×ª ×¦×™×•×Ÿ"],
    desc: "×©××¨×• ×¢×œ ×‘×˜×—×•×Ÿ"
  },
  {
    id: "demo3",
    cat: "13",
    title: "×©×¨×™×¤×•×ª",
    data: ["×—×™×¤×”", "×›×¨××™××œ", "× ×”×¨×™×”", "×¢×›×•"],
    desc: "×¤× ×• ×œ××–×•×¨ ×‘×˜×•×—"
  },
  {
    id: "demo4",
    cat: "1",
    title: "×™×¨×™ ×¨×§×˜×•×ª ×•×˜×™×œ×™×",
    data: ["×‘××¨ ×©×‘×¢", "×“×™××•× ×”", "×¨×”×˜", "×©×“×¨×•×ª", "× ×ª×™×‘×•×ª", "××•×¤×§×™×"],
    desc: "×”×™×›× ×¡×• ×œ××¨×—×‘ ×”××•×’×Ÿ"
  }
];

let demoInterval = null;
let demoIndex = 0;

async function loadDemo() {
  isDemo = true;
  demoIndex = 0;
  clearMarkers();
  showDemoAlert(DEMO_ALERTS[0]);
  setStatus('', '××¦×‘ ×“××•');
  document.getElementById('demo-banner').style.display = 'block';
  
  if (demoInterval) clearInterval(demoInterval);
  demoInterval = setInterval(() => {
    demoIndex = (demoIndex + 1) % DEMO_ALERTS.length;
    showDemoAlert(DEMO_ALERTS[demoIndex]);
  }, 4000);
}

function showDemoAlert(data) {
  lastId = data.id;
  clearMarkers();
  renderActive(data);
  placeMarkers(data);
  playAlert();
  if (Notification.permission === 'granted') {
    new Notification(`ğŸ”” ${data.title}`, { body: (data.data||[]).slice(0,3).join(', ') });
  }
  document.getElementById('upd').textContent = '×“××• ' + (demoIndex + 1) + '/' + DEMO_ALERTS.length;
}

let lastId = null;
let polling = false;

async function poll() {
  if (polling) return;   // skip if previous request still in flight
  polling = true;
  try {
    const res  = await fetch(ALERTS_URL, { cache: 'no-store' });
    const text = (await res.text()).trim().replace(/^\uFEFF/, '');
    const data = (text && text !== 'null' && text !== '\r\n') ? JSON.parse(text) : null;

    setStatus('', '××—×•×‘×¨');
    document.getElementById('upd').textContent = new Date().toLocaleTimeString('he-IL');

    const id = data?.id ?? null;

    if (isDemo) {
      // While demo is active: only switch away if a REAL alert comes in
      if (data) {
        isDemo = false;
        document.getElementById('demo-banner').style.display = 'none';
        lastId = id;
        clearMarkers();
        renderActive(data);
        playAlert();
        if (Notification.permission === 'granted') {
          new Notification(`ğŸš¨ ${data.title}`, { body: (data.data||[]).slice(0,3).join(', ') });
        }
        placeMarkers(data);
        loadHistory();
      }
      return; // keep demo on screen while there's no real alert
    }

    if (id !== lastId) {
      lastId = id;
      clearMarkers();
      renderActive(data);
      if (data) {
        playAlert();
        if (Notification.permission === 'granted') {
          new Notification(`ğŸš¨ ${data.title}`, { body: (data.data||[]).slice(0,3).join(', ') });
        }
        placeMarkers(data);
        loadHistory();
      }
    }
  } catch(e) {
    setStatus('err', '×©×’×™××ª ×—×™×‘×•×¨');
  } finally {
    polling = false;
  }
}

if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

loadHistory();
poll();
setInterval(poll, POLL_MS);
setInterval(loadHistory, 60_000);
</script>
</body>
</html>
